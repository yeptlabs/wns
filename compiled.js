function wnConsole(){self=this,this.className="wnConsole"}var self={},className="wnConsole",klass=wnConsole,classProto=wnConsole.prototype,__extend=["wnComponent","wnModule"];classProto.construct=function(){};var _=self,_parent={e:{}},_initialized=!1,_config={},_events={},_eventsConfig={},_classBuilder={},_className="";classProto.getClassName=function(){return className},classProto.getExtend=function(){return __extend},classProto.instanceOf=function(name){return-1!=__extend.indexOf(name+"")},classProto.setConfig=function(extend){return"object"!=typeof extend?!1:(_config=Object.extend(!0,_config,extend),!0)},classProto.getConfig=function(attr){return attr?_config[attr]:_config},classProto.exportConfig=function(obj){if("undefined"==typeof obj&&(obj=this.getConfig(),delete obj.class),"object"==typeof obj){delete obj.autoInit,delete obj.id,delete obj.serverID,delete obj.modulePath;for(o in obj)this.exportConfig(obj[o])}return JSON.stringify(obj,null,"	")},classProto.getFile=function(filePath){if("function"==typeof arguments[1])var cb=arguments[1];if("function"==typeof arguments[2])var cb=arguments[2];var binary="boolean"==typeof arguments[1]?arguments[1]:!1,realPath=this.instanceOf("wnModule")?this.modulePath+filePath:filePath,cmd=cb?"readFile":"readFileSync";try{var _cb=cb?function(err,file){cb&&cb(err?!1:binary===!0?file:file.toString())}:null,file=fs[cmd](realPath,_cb)}catch(e){if(!_cb)return!1;cb&&cb(!1)}return file?binary===!0?file:file.toString():!1},classProto.getFileStat=function(filePath,cb){var realPath=this.instanceOf("wnModule")?this.modulePath+filePath:filePath,cmd=cb?"stat":"statSync";if(!fs.existsSync(realPath))return cb&&1==cb(!1);var _cb=cb?function(err,stat){cb&&cb(err?!1:stat)}:null,stat=fs[cmd](realPath,_cb);return stat},classProto.preloadEvents=function(){this.e.log&&this.e.log("Preloading events...","system");var preload=Object.extend(!0,{},this.defaultEvents,this.getConfig().events);void 0!=preload&&this.setEvents(preload);for(e in preload)this.getEvent(e);return this.attachEventsHandlers(),this},classProto.createClass=function(className,config){var source=this.c||process.wns,builder=this.getComponent&&this.getComponent("classBuilder");source.name="",config.id&&(source[className].build.id=config.id);var instance=new source[className](config,source);if(WNS_TEST&&builder){console.log("- Testing "+className);var tests=builder.classes[className].test;for(t in tests)tests[t](instance)}return instance},classProto.attachEventsHandlers=function(){this.e.log&&this.e.log("Attaching default event's handlers...","system");var events=this.getEvents();for(e in events){var eventName=e.split("-").pop(),event=this.getEvent(eventName),evtConfig=event.getConfig();if(null!=evtConfig.handler&&this[evtConfig.handler]&&"function"==typeof this[evtConfig.handler]&&(event.addListener(this[evtConfig.handler]),event.setConfig({handler:null})),null!=evtConfig.listenEvent&&-1==e.indexOf("event-module")&&this.hasEvent(evtConfig.listenEvent)){var listenTo=this.getEvent(evtConfig.listenEvent);evtConfig.listenEvent+"",listenTo.addListener(function(e){return"object"==typeof e&&1==e.stopPropagation?!1:(this.event.push.apply(this.event,arguments),void 0)}.bind({event:event})),event.setConfig({listenEvent:null})}}},classProto.setEvents=function(events){var event={};for(e in events){var ref=events[e],e="event-"+e.replace("-",".");event[e]=ref,event[e].class=ref.class||"wnEvent",event[e].eventName=e.split("-").pop(),this.hasEvent(e)&&Object.extend(!0,event[e],this.getEvent(e)),_eventsConfig[e]=Object.extend(!0,_eventsConfig[e]||{},event[e])}return this},classProto.getEvent=function(name,hidden){var eventName="event-"+name;if(void 0!=_events[eventName])return _events[eventName];if(!_eventsConfig[eventName]||!this.c)return!1;var config=_eventsConfig[eventName]||{},_class=config.class;config.id=eventName,config.autoInit=!1;var evt=this.createClass(_class,config);return evt.setParent(this),evt.init(),0!=hidden?(_events[eventName]=evt,this.e[name]=function(){evt.push.apply(evt,arguments)}):Object.defineProperty(_events[eventName],{value:evt,enumerable:!1}),evt},classProto.getEvents=function(){return _events},classProto.getEventsConfig=function(){return _eventsConfig},classProto.hasEvent=function(name){return void 0!=_events["event-"+name]},classProto.once=function(eventName,handler){var event;return(event=this.getEvent(eventName))?event.once(handler)||this.e.log("Invalid handler sent to event `"+eventName+"` on `"+this.getConfig("id")+"`","warning"):this.e.log("Not existent event `"+eventName+"` on `"+this.getConfig("id")+"`","warning"),this},classProto.addListener=function(eventName,handler){var event;return(event=this.getEvent(eventName))?event.addListener(handler)||this.e.log("Invalid handler sent to event `"+eventName+"` on `"+this.getConfig("id")+"`","warning"):this.e.log("Not existent event `"+eventName+"` on `"+this.getConfig("id")+"`","warning"),this},classProto.prependListener=function(eventName,handler){var event;return(event=this.getEvent(eventName))?event.prependListener(handler)||this.e.log("Invalid handler sent to event `"+eventName+"` on `"+this.getConfig("id")+"`","warning"):this.e.log("Not existent event `"+eventName+"` on `"+this.getConfig("id")+"`","warning"),this},classProto.prependOnce=function(eventName,handler){var event;return(event=this.getEvent(eventName))?event.once(handler,!0)||this.e.log("Invalid handler sent to event `"+eventName+"` on `"+this.getConfig("id")+"`","warning"):this.e.log("Not existent event `"+eventName+"` on `"+this.getConfig("id")+"`","warning"),this},classProto["export"]=function(){var _export={},merge={};Object.extend(merge,this.getConfig(),this);for(p in merge)("object"!=typeof merge[p]&&"function"!=typeof merge[p]||null==merge[p]||void 0==merge[p].instanceOf)&&(_export[p]=merge[p]);return _export},classProto.getParent=function(){return _parent},classProto.setParent=function(newParent){return"object"==typeof newParent&&(_parent=newParent),this},classProto.getIsInitialized=function(){return _initialized},classProto.init=function(){return this},classProto.exec=function(cmd,context){var ctx=void 0!=context?context:this;try{!function(){self.e.log&&self.e.log(util.inspect(eval(cmd)),"result")}.bind(ctx)()}catch(e){this.e.exception&&this.e.exception(e)}return this},classProto.e={log:function(){}},classProto.c={},classProto.m={},classProto.defaultEvents={},classProto.construct=function(config,classes){Object.defineProperty(this,"c",{value:classes||{},enumerable:!1,writable:!1}),this.setConfig(config),this.preloadEvents(),0!=this.getConfig("autoInit")&&this.init.apply(this,arguments),_initialized=!0};var _=self,_modules={},_modulesConfig={},_components={},_componentsConfig={},_customClasses={},_modulesEvents={};classProto.importClasses=function(){this.e.log&&this.e.log("Importing core classes...","system");var _c={},_cSource={};for(c in global.coreClasses){var module={},_class=global.coreClasses[c];eval(_class),_c[c]=module.exports,_cSource[c]=_class}var classBuilder=new process.wns.wnBuild(_c,this);this.setComponent("classBuilder",classBuilder),classBuilder.build();for(c in global.coreClasses)classBuilder.makeDoc(c,_cSource[c]);if(WNS_TEST)for(c in global.coreClasses)classBuilder.makeTest(c,_cSource[c]);return this},classProto.importFromConfig=function(){this.e.log&&this.e.log("Importing...","system");var importConfig=this.getConfig("import");for(i in importConfig){var path=this.modulePath+importConfig[i];if(this.e.log&&this.e.log("Importing "+path+"...","system"),fs.existsSync(path)){var components=fs.readdirSync(path);for(c in components)if("js"==components[c].split(".").pop()){var module={},componentName=components[c].split(".")[0],componentClassName=componentName,componentSet={},_component=fs.readFileSync(path+components[c],"utf-8").toString();eval(_component);var cb=this.getComponent("classBuilder");cb.classes[componentClassName]=cb.recompile(componentClassName,module.exports),cb.makeDoc(componentClassName,_component)}}}},classProto.prepareModels=function(){for(c in this.c)this.c[c].build&&this.c[c].build.extend&&-1!=this.c[c].build.extend.indexOf("wnActiveRecord")&&this.prepareModel(c)},classProto.prepareModel=function(model){var c=this.c,s=this;this.m[model]=function(){var modelClass=c[model];return new modelClass({autoInit:!0},s.c,s,s.db)}},classProto.prepareScripts=function(){for(c in this.c)this.c[c].build&&this.c[c].build.extend&&-1!=this.c[c].build.extend.indexOf("wnScript")&&this.prepareScript(c)},classProto.prepareScript=function(s){var components={};components["script-"+s]={"class":s,autoInit:!1,seeParent:!0},this.setComponents(components),this.e.log&this.e.log("- Starting script: "+s,"system"),this.getComponent("script-"+s)},classProto.configureFromFile=function(file){var file=file+"";if(this.e.log&&this.e.log("Loading module configuration from file: "+file,"system"),fs.statSync(file).isFile()&&".json"==path.extname(file)){var _data=fs.readFileSync(file,"utf8").toString().replace(/\\/g,function(){return"\\"+arguments[0]}).replace(/\/\/.+?(?=\n|\r|$)|\/\*[\s\S]+?\*\//g,"");if(_data=JSON.parse(_data))return this.setConfig(_data,!0),!0}return!1},classProto.setComponents=function(components){for(c in components)this.hasComponent(c)&&Object.extend(!0,components[c],this.getComponent(c)),_componentsConfig[c]=Object.extend(!0,_componentsConfig[c]||{},components[c]);return this},classProto.setComponent=function(id,component){return component?_components[id]=component:delete _components[id],this},classProto.getComponent=function(id){if(void 0!=_components[id])return _components[id];if(this.hasComponent("classBuilder")){var config=_componentsConfig[id]||{},className=config.class||id;if(this.getComponent("classBuilder").exists(className)){config.id=id,config.autoInit=1==config.autoInit;var component=this.createComponent(className,config);return config.setParent&&component.setParent(this),self.e.loadComponent(e,id,component),!config.autoInit&&component.init(config),_components[id]=component,"string"==typeof config.alias&&(this[config.alias]=_components[id]),_components[id]}return!1}},classProto.removeComponent=function(id){var id=id+"";return void 0!=_components[id]&&(_componentsConfig[id].alias&&(this[_componentsConfig[id].alias]=void 0),_components[id]=void 0),this},classProto.createComponent=function(className,config){var component=this.createClass(className,config);return component.setParent(this),component},classProto.hasComponent=function(id){return void 0!=_components[id]},classProto.getComponents=function(){return _components},classProto.getComponentsConfig=function(){return _componentsConfig},classProto.getComponentConfig=function(id){return _componentsConfig[id]},classProto.preloadComponents=function(){this.setConfig({components:this.preload});var preload=this.getConfig().components;return void 0!=preload&&(this.e.log&&this.e.log("Preloading components...","system"),this.setComponents(preload)),this},classProto.startComponents=function(){var cps=this.getComponentsConfig();for(c in cps){var cpnt=this.getComponent(c);cpnt&&this.e.log&&this.e.log("- Started component: "+cps[c].class+(cpnt.getConfig("alias")?" (as "+cpnt.getConfig("alias")+")":""),"system")}return this},classProto.setModules=function(modules){for(m in modules)this.hasModule(m)&&Object.extend(!0,modules[m],this.getModule(m)),_modulesConfig[m]=Object.extend(!0,_modulesConfig[m]||{},modules[m]);return this},classProto.getModule=function(id,onLoad){if(void 0!=_modules[id])return _modules[id];if(this.hasComponent("classBuilder"))try{var config=_modulesConfig[id]||{},modulePath=config.modulePath||id,className=config.class;if(fs.existsSync(this.modulePath+modulePath)&&void 0!=className){config.id=id,config.autoInit=!(0==config.autoInit);var npmPath=[];for(n in self.npmPath)npmPath.push(self.npmPath[n]);npmPath.unshift(this.modulePath+modulePath+"/node_modules/");var module=this.createModule(className,modulePath,config,npmPath);return _modules[id]=module,this.attachModuleEvents(id),onLoad&&onLoad(module),self.e.loadModule(id,module),process.nextTick(function(){module.e.ready(modulePath,config)}),_modules[id]}return!1}catch(e){this.e.log&&this.e.log("wnModule.getModule: Error at loading `"+id+"`"),this.e.exception&&this.e.exception(e)}},classProto.hasModule=function(id){return void 0!=_modules[id]},classProto.createModule=function(className,modulePath,config,npmPath){return new this.c[className](this,modulePath,config,npmPath)},classProto.getModules=function(){return _modules},classProto.getModulesConfig=function(){return _modulesConfig},classProto.attachModuleEvents=function(id){var events,module=this.getModule(id);if(this.e.log&&this.e.log("Attaching module's events...","system"),void 0!=module&&(events=module.getEvents())&&!Object.isEmpty(events)){for(e in events){var eventClass,evtConfig={},eventName="module."+e.split("-").pop(),evtCnf=events[e].getConfig(),event=events[e];!this.hasEvent(eventName)&&evtCnf.bubble&&-1==e.indexOf("event-module")&&(evtConfig[eventName]=Object.extend(!0,evtConfig[eventName],evtCnf),evtConfig[eventName].listenEvent=null,evtConfig[eventName].handler=null,this.setEvents(evtConfig),this.getEvent(eventName)),this.hasEvent(eventName)&&-1==e.indexOf("event-module")&&(eventClass=this.getEvent(eventName),event.prependListener(function(e){return"object"==typeof e&&1==e.stopPropagation?!1:(eventClass.push.apply(eventClass,arguments),void 0)}))}this.attachEventsHandlers()}return this},classProto.getModuleEvent=function(eventName){return this.getEvent("module."+eventName)},classProto.setScripts=function(scripts){var script={};for(s in scripts){var ref=scripts[s],scriptName=s.substr(0,1).toUpperCase()+s.substr(1).toLowerCase(),s="script-"+s.replace("-",".");script[s]=ref,script[s].class="wnScript"+scriptName||"wnScript",_componentsConfig[s]=Object.extend(!0,_componentsConfig[s]||{},script[s])}return this},classProto.getScript=function(name){return this.getComponent("script-"+name)},classProto.hasScript=function(name){return void 0!=_components["script-"+name]},classProto.startScript=function(name){var script;return(script=this.getScript(name))?(script.start(),script):!1},classProto.stopScript=function(name){var script;return(script=this.getScript(name))?(script.stop(),script):!1},classProto.getModulePath=function(){return this.modulePath},classProto.setModulePath=function(value){return void 0!=value&&fs.statSync(value).isDirectory()&&(this.modulePath=value,this.setConfig("modulePath",value)),this},classProto.syncServer=function(){this.setComponents({syncServer:{port:22011,"class":"wnSync"}});var syncServer=this.getComponent("syncServer");return syncServer.setParent(this),syncServer.init(),syncServer},classProto.checkPackage=function(){return!0},classProto.installPackage=function(packageName,cb){packageName&&this.checkPackage(packageName)||cb&&cb(!1),self.e.log("Downloading `%d` package...",packageName);var file=fs.createWriteStream(this.modulePath+"/.tmp/"+packageName+".tar.gz");fs.existsSync(this.modulePath+"/.tmp")||fs.mkdirSync(this.modulePath+"/.tmp");var req=http.request({method:"GET",host:process.wns.info.wnspm.url,path:"/package/download"},function(response){cb&&cb(!0),response.pipe(file)});req.on("error",function(){cb&&cb(!1)}),req.end()},classProto.removePackage=function(){},classProto.preinit=function(){return this},classProto.run=function(){return this},classProto.configFile="config.json",classProto.modulePath="/",classProto.preload={},classProto.behaviors={},classProto.defaultEvents={loadModule:{},loadComponent:{}},classProto.npmPath=[],classProto.construct=function(parent,modulePath,config,npmPath,classes){this.e.log&&this.e.log("Constructing new `"+this.className+"`...","system"),void 0==modulePath&&(modulePath=cwd);try{this.setParent(parent)}catch(e){e&&console.log(this)}this.setModulePath(path.resolve(path.resolve(parent.modulePath,modulePath))+"/"),this.preinit.apply(this,arguments),this.npmPath=npmPath||[],this.importClasses(),void 0==classes?this.c=this.getComponent("classBuilder").classes:Object.defineProperty(this,"c",{value:classes,enumerable:!1,writable:!1});var defaultConfig=cwd+sourcePath+"config/"+className.split("_")[0]+"Config.json";fs.existsSync(defaultConfig)&&this.configureFromFile(defaultConfig),fs.existsSync(this.modulePath+this.configFile)&&this.configureFromFile(this.modulePath+this.configFile),config&&this.setConfig(config),this.importFromConfig(),this.preloadComponents(),this.preloadEvents(),this.setEvents({ready:{}});var ready=this.getEvent("ready");ready.once(function(e){e.stopPropagation=!0;var args=Array.prototype.slice.call(arguments);args.shift(),self.startComponents(),self.prepareModels(),self.prepareScripts(),self.init.apply(self,args),self.run.apply(self,args),_initialized=!0}),0!=this.getConfig("autoInit")&&process.nextTick(function(){self.e.ready.apply(this,arguments)})};var _=self,_server={},_serverModules=[];classProto.init=function(){this.setConfig({id:"*"}),this.listenInput(),process.on("uncaughtException",function(e){self.e.exception(e)}),this.e.log("wnConsole initialized.")},classProto.listenInput=function(){process.stdin.resume(),process.stdin.setEncoding("utf8"),process.stdin.on("data",function(chunk){var ctx=self.getServer(self.activeServer),cmd=chunk.substr(0,chunk.length-1);return".."==cmd.substr(0,2)&&(ctx=!1,cmd="this.selectServer(-1)"),self.exec(cmd,ctx?ctx:void 0),!1})},classProto.buildServer=function(serverPath){var _sourcePath=cwd+sourcePath,relativeSourcePath=path.relative(serverPath,_sourcePath)+"/",relativeServerPath=path.relative(cwd,serverPath);self.e.log("[*] Building new wnServer on `"+serverPath+"`"),fs.existsSync(serverPath)||fs.mkdirSync(serverPath),self.e.log("[*] - Creating new `package.js` file.");var defaultPackage=fs.readFileSync(_sourcePath+"/default-package.json").toString("utf8");defaultPackage=(defaultPackage+"").replace(/\{moduleName\}/g,"server-"+serverPath.substr(0,serverPath.length-1).split("/").pop().replace(/\s/g,"-")),fs.writeFileSync(serverPath+"/package.json",defaultPackage),self.e.log("[*] - Creating new `config.json` file."),fs.writeFileSync(serverPath+"/config.json",fs.readFileSync(_sourcePath+"/default-config.json")),self.e.log("[*] - Creating new `index.js` file.");var defaultIndex=fs.readFileSync(_sourcePath+"/default-index.js").toString("utf8");return defaultIndex=defaultIndex.replace(/\{sourcePath\}/g,"./"+relativeSourcePath.replace(/\\/g,"/")),defaultIndex=defaultIndex.replace(/\{serverPath\}/g,"./"+relativeServerPath.replace(/\\/g,"/")),fs.writeFileSync(serverPath+"/index.js",defaultIndex),self.e.log("[*] New wnServer created."),!0},classProto.setServers=function(servers){var modules={};for(s in servers){var ref=servers[s],s="server-"+s;modules[s]=ref,modules[s].modulePath=modules[s].serverPath||modules[s].modulePath,modules[s].class="wnServer",modules[s].autoInit=!1}this.setModules(modules)},classProto.setServer=function(id,server){this.hasModule("server-"+id)&&null==server?delete this.getModule("server-"+id):this.setModule("server-"+id,server)},classProto.getServer=function(id){return this.getModule("server-"+id)},classProto.createServer=function(id){var m=this.getModule("server-"+id,function(server){self.e.loadServer(server)});return _serverModules.push(m),m},classProto.hasServer=function(id){return this.hasModule("server-"+id)},classProto.getServers=function(){return _server},classProto.getServerModules=function(){return _serverModules},classProto.addServer=function(serverPath,relativeMainPath){relativeMainPath&&(serverPath=path.relative(cwd,path.resolve(mainPath,serverPath)));var serverConfig={},consoleID=this.getServerModules().length+1;if(serverConfig[consoleID]={modulePath:serverPath,serverID:consoleID},this.e.log("[*] Building wnServer from `"+serverPath+"`"),!fs.existsSync(this.modulePath+serverPath))return this.e.log("[*] Failed to load wnServer from path."),!1;this.setServers(serverConfig);var server=this.createServer(consoleID);return this.selectServer(consoleID),server},classProto.selectServer=function(id){this.hasServer(id)?(this.e.log("[*] Console active in SERVER#"+id),this.activeServer=id):(this.e.log("[*] Console active in NONE"),this.activeServer=-1)},classProto.logHandler=function(e,data){var prefix="",sourceName=e.owner.getConfig("id");sourceName&&(prefix="["+sourceName+"]"+" "),!WNS_QUIET_MODE&&console.log(prefix+""+data)},classProto.logFilter=function(){return server.getConfig("consoleID")==this.activeServer?!0:!1},classProto.exceptionHandler=function(e,err){if("string"==typeof err||"object"!=typeof err||void 0==err.stack)return!1;e.owner.e.log("ERROR: "+err.message,"exception");var _stack=err.stack.split("\n");_stack.shift();for(s in _stack)e.owner.e.log(_stack[s],"stack")},classProto.configFile="console.json",classProto.activeServer=-1,classProto.defaultEvents={loadModule:{},loadComponent:{},loadServer:{},exception:{},log:{handler:"logHandler"}};